{% extends "base.html" %}
{% load static humanize %}

{% block title %}ì¼ì •ê´€ë¦¬ - ì›¨ë”© í”Œë˜ë„ˆ{% endblock %}

{% block content %}
<!-- ============================================================
     SCHEDULE TAB â€” Trendy Redesign
     ë””ìì¸ë¶€ì¥ ë‹´ë‹¹ | Calendar + Side Panel + Upcoming
     ============================================================ -->

{% include 'weddings/includes/_dashboard_tabs.html' %}

<div class="schedule-container max-w-[1200px] mx-auto pb-20">

    <!-- Section 1: Full Width Calendar -->
    <section class="schedule-section reveal mb-16" data-reveal="fade-up">
        <!-- Header for Calendar -->
        <div class="text-center mb-10">
            <h2 class="text-3xl font-bold text-gray-900 tracking-tight font-serif italic">Schedule</h2>
            <div class="w-8 h-0.5 bg-gray-800 mx-auto mt-4 mb-2"></div>
            <p class="text-xs text-gray-400 uppercase tracking-widest mt-2">Manage your wedding timeline</p>
        </div>

        <div class="sch-calendar shadow-xl rounded-[24px] overflow-hidden border border-gray-100 bg-white">
            <div class="sch-calendar__card" style="box-shadow: none; border: none;">
                <!-- Header -->
                <div class="sch-calendar__header p-6 border-b border-gray-50">
                    <a href="?year={{ prev_year }}&month={{ prev_month }}"
                        class="sch-calendar__nav-btn hover:bg-gray-100">
                        <i class="bi bi-chevron-left"></i>
                    </a>
                    <div class="sch-calendar__title-area">
                        <h3 class="sch-calendar__title text-2xl font-playfair">{{ current_year }}ë…„ {{ current_month }}ì›”
                        </h3>
                        <button type="button" class="sch-calendar__picker-btn text-gray-400 hover:text-pink-500"
                            data-bs-toggle="modal" data-bs-target="#datePickerModal">
                            <i class="bi bi-calendar-date"></i>
                        </button>
                    </div>
                    <a href="?year={{ next_year }}&month={{ next_month }}"
                        class="sch-calendar__nav-btn hover:bg-gray-100">
                        <i class="bi bi-chevron-right"></i>
                    </a>
                </div>

                <!-- Legend -->
                <div class="sch-calendar__legend px-6 py-3 bg-gray-50/50">
                    <div class="sch-legend">
                        <span class="sch-legend__dot sch-legend__dot--task"></span>
                        <span class="text-xs font-bold text-gray-500">ì¼ì •</span>
                    </div>
                    <div class="sch-legend">
                        <span class="sch-legend__dot sch-legend__dot--memo"></span>
                        <span class="text-xs font-bold text-gray-500">ë©”ëª¨</span>
                    </div>
                    <div class="sch-legend">
                        <span class="sch-legend__dot sch-legend__dot--wedding"></span>
                        <span class="text-xs font-bold text-gray-500">ê²°í˜¼ì‹</span>
                    </div>
                </div>

                <!-- Calendar Grid -->
                <!-- Added 'min-h-[600px]' for taller calendar -->
                <table class="sch-table w-full min-h-[700px]">
                    <thead>
                        <tr class="bg-gray-50/80 text-gray-500">
                            <th class="sch-table__day sch-table__day--sun py-4">ì¼</th>
                            <th class="sch-table__day py-4">ì›”</th>
                            <th class="sch-table__day py-4">í™”</th>
                            <th class="sch-table__day py-4">ìˆ˜</th>
                            <th class="sch-table__day py-4">ëª©</th>
                            <th class="sch-table__day py-4">ê¸ˆ</th>
                            <th class="sch-table__day sch-table__day--sat py-4">í† </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for week in calendar %}
                        <tr>
                            {% for day_info in week %}
                            <td class="align-top border-t border-r border-gray-100 last:border-r-0 h-[120px]">
                                {% if not day_info.is_empty %}
                                <div class="sch-cell h-full p-2 transition-colors hover:bg-pink-50/30 cursor-pointer relative
                                    {% if day_info.is_today %}bg-pink-50/50{% endif %}
                                    {% if day_info.is_selected %}ring-2 ring-inset ring-pink-200 bg-white{% endif %}
                                    {% if day_info.is_wedding_day %}bg-gradient-to-br from-pink-100 to-purple-50{% endif %}"
                                    onclick="selectDate(this, {{ current_year }}, {{ current_month }}, {{ day_info.day }})"
                                    ondragover="allowDrop(event)"
                                    ondrop="dropTask(event, '{{ current_year }}-{{ current_month }}-{{ day_info.day }}')"
                                    data-log-content="{{ day_info.log_content|default:'' }}">

                                    <span
                                        class="sch-cell__num text-sm font-bold
                                        {% if day_info.is_today %}text-pink-500 bg-white rounded-full w-6 h-6 flex items-center justify-center shadow-sm{% else %}text-gray-400{% endif %}">
                                        {{ day_info.day }}
                                    </span>

                                    {% if day_info.is_wedding_day %}
                                    <div class="absolute top-2 right-2 text-2xl animate-bounce">ğŸ’</div>
                                    <div class="mt-8 text-center">
                                        <span
                                            class="text-xs font-bold text-pink-600 bg-white/80 px-2 py-1 rounded-full shadow-sm">Wedding
                                            Day!</span>
                                    </div>
                                    {% endif %}

                                    <!-- Events (Pills) -->
                                    <div class="sch-cell__events flex flex-col gap-1 mt-1">
                                        {% if day_info.has_log %}
                                        <div class="sch-event-pill sch-event-pill--memo"
                                            title="{{ day_info.log_content }}">
                                            <i class="bi bi-journal-text"></i> {{ day_info.log_content|truncatechars:6 }}
                                        </div>
                                        {% endif %}

                                        {% for task in day_info.tasks|slice:":2" %}
                                        <div class="sch-event-pill sch-event-pill--task" title="{{ task.title }}">
                                            {{ task.title|truncatechars:6 }}
                                        </div>
                                        {% endfor %}

                                        {% if day_info.tasks|length > 2 %}
                                        <div class="sch-event-pill sch-event-pill--more">+{{ day_info.tasks|length|add:"-2" }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% else %}
                                <div class="sch-cell sch-cell--empty h-full bg-gray-50/30"></div>
                                {% endif %}
                            </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- â”€â”€â”€ Visual Section Divider â”€â”€â”€ -->
    <div class="flex items-center gap-4 my-16 opacity-40">
        <div class="flex-1 h-px bg-gradient-to-r from-transparent via-gray-300 to-transparent"></div>
        <i class="bi bi-stars text-gray-300"></i>
        <div class="flex-1 h-px bg-gradient-to-r from-transparent via-gray-300 to-transparent"></div>
    </div>

    <!-- â”€â”€â”€ Section 2: Interactive Graph Timeline â”€â”€â”€ -->
    <!-- â”€â”€â”€ Section 2: Interactive Graph Timeline (Bezier) â”€â”€â”€ -->
    <section class="schedule-section reveal mb-16" data-reveal="fade-up">
        <div class="text-center mb-10">
            <span
                class="inline-block px-4 py-1.5 rounded-full text-[10px] font-extrabold uppercase tracking-widest bg-pink-50 text-pink-500 border border-pink-100 mb-3">
                <i class="bi bi-bezier2 mr-1"></i>Timeline Flow
            </span>
            <h3 class="text-2xl font-extrabold text-gray-800">ì›¨ë”© ì¤€ë¹„ íë¦„</h3>
            <p class="text-sm text-gray-400 mt-1">ì˜¤ëŠ˜ë¶€í„° ê²°í˜¼ì‹ê¹Œì§€ì˜ ì—¬ì •</p>
        </div>

        <div
            class="relative w-full max-w-[1000px] mx-auto min-h-[400px] bg-white/50 rounded-[30px] shadow-sm border border-gray-100 overflow-hidden">

            <!-- Decorative Blobs -->
            <div class="floating-blob blob-1"></div>
            <div class="floating-blob blob-2"></div>

            <!-- SVG Container -->
            <svg class="timeline-svg relative z-10" id="timelineSvg" preserveAspectRatio="none">
                <defs>
                    <linearGradient id="gradientStroke" x1="0%" y1="0%" x2="100%" y2="0%">
                        <stop offset="0%" style="stop-color:#FF8E8E; stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#FFB5B5; stop-opacity:1" />
                    </linearGradient>
                    <filter id="glow" x="-20%" y="-20%" width="140%" height="140%">
                        <feGaussianBlur stdDeviation="3" result="blur" />
                        <feComposite in="SourceGraphic" in2="blur" operator="over" />
                    </filter>
                </defs>
                <!-- Gray Background Path -->
                <path class="timeline-path-bg" id="pathBg" d="" />
                <!-- Active Animated Path -->
                <path class="timeline-path-active" id="pathActive" d="" />
            </svg>

            <!-- Nodes Container (Absolute Overlay) -->
            <div id="timelineNodes" class="absolute inset-0 pointer-events-none z-20">
                <!-- Nodes will be injected here via JS -->
            </div>
        </div>
    </section>

    <!-- â”€â”€â”€ Section 3: Recommendation Cards (Bento Grid) â”€â”€â”€ -->
    <section class="schedule-section reveal" data-reveal="fade-up" id="dDaySection">
        <div class="max-w-[1000px] mx-auto">
            <div class="flex items-center justify-between mb-8">
                <div>
                    <h3 class="text-2xl font-extrabold text-gray-900">
                        {% if days_left is not None %}
                        <span class="text-pink-accent">D-{{ days_left }}</span> ì²´í¬ë¦¬ìŠ¤íŠ¸
                        {% else %}
                        ì›¨ë”© ë°ì´ ì„¤ì • í•„ìš”
                        {% endif %}
                    </h3>
                    <p class="text-gray-500 text-sm mt-1">ì˜¤ëŠ˜ ê¼­ ì±™ê²¨ì•¼ í•  ì¤‘ìš” í•­ëª©ë“¤</p>
                </div>
                <a href="{% url 'checklist_manage' %}" class="btn btn-sm btn-outline-primary rounded-full px-4">
                    ì „ì²´ë³´ê¸° <i class="bi bi-arrow-right ml-1"></i>
                </a>
            </div>

            <!-- Bento Grid -->
            <div class="bento-grid">
                {% for action in d_day_actions %}
                <div class="bento-card glass-card-hover group">
                    <div>
                        <div
                            class="bento-icon-box bg-gradient-to-br from-pink-100 to-white text-pink-500 group-hover:scale-110 transition-transform">
                            <i class="bi {% cycle 'bi-stars' 'bi-clipboard-check' 'bi-gift' %}"></i>
                        </div>
                        <h4 class="font-bold text-lg text-gray-800 mb-2">{{ action.title }}</h4>
                        <p class="text-sm text-gray-500 leading-relaxed">{{ action.desc }}</p>
                    </div>
                    <button class="cta-done-btn mt-4">
                        <i class="bi bi-check2"></i> ì™„ë£Œ í‘œì‹œ
                    </button>
                </div>
                {% empty %}
                <div
                    class="col-span-full py-12 text-center bg-gray-50 rounded-[24px] border border-dashed border-gray-200">
                    <div class="text-6xl mb-4">ğŸ‰</div>
                    <h4 class="font-bold text-gray-400">ì˜¤ëŠ˜ì€ í•  ì¼ì´ ì—†ë„¤ìš”!</h4>
                    <p class="text-gray-400 text-sm">í‘¹ ì‰¬ê±°ë‚˜ ë‹¤ìŒ ì¼ì •ì„ ë¯¸ë¦¬ í™•ì¸í•´ë³´ì„¸ìš”.</p>
                </div>
                {% endfor %}

                <!-- Manual Add Card -->
                <a href="#" data-bs-toggle="modal" data-bs-target="#dateActionModal"
                    class="bento-card group border-dashed border-2 border-gray-200 bg-transparent hover:bg-pink-50/50 hover:border-pink-200 cursor-pointer flex flex-col items-center justify-center text-center p-6 h-full min-h-[200px]">
                    <div
                        class="w-12 h-12 rounded-full bg-gray-100 text-gray-400 flex items-center justify-center mb-3 group-hover:bg-pink-100 group-hover:text-pink-500 transition-colors">
                        <i class="bi bi-plus text-2xl"></i>
                    </div>
                    <span class="font-bold text-gray-400 group-hover:text-pink-500">ì§ì ‘ ì¶”ê°€í•˜ê¸°</span>
                </a>
            </div>
        </div>
    </section>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // â”€â”€â”€ 1. Bezier Timeline Logic â”€â”€â”€
        const svg = document.getElementById('timelineSvg');
        const pathBg = document.getElementById('pathBg');
        const pathActive = document.getElementById('pathActive');
        const nodesContainer = document.getElementById('timelineNodes');

        if (!svg) return;

        // Data from Django
        const rawDaysLeft = parseInt("{{ days_left|default:'0' }}");
        const daysLeft = isNaN(rawDaysLeft) ? 30 : rawDaysLeft;

        // Construct Events Array from Server Data
        let eventsData = [
            {% for event in timeline_events %}
            {
            title: "{{ event.title|escapejs }}",
            date: "{{ event.date|date:'Y.m.d' }}",
            dDay: {{ event.d_day }},
        type: "{{ event.type }}",
        category: "{{ event.category|default:'' }}"
            },
        {% endfor %}
        ];

    // 1. Add Start Node (Today)
    let timelinePoints = [
        { x: 0, y: 0, label: "Today", dDay: 0, active: true, isStart: true }
    ];

    // 2. Add Event Nodes
    const maxDDay = daysLeft > 0 ? daysLeft : 1;

    eventsData.forEach((ev, idx) => {
        if (ev.dDay >= 0 && ev.dDay <= maxDDay) {
            timelinePoints.push({
                ...ev,
                label: `D-${daysLeft - ev.dDay}`,
                active: false
            });
        }
    });

    // 3. Add End Node (Wedding)
    timelinePoints.push({
        x: 0, y: 0,
        label: "Wedding",
        dDay: maxDDay,
        active: false,
        isEnd: true
    });

    // â”€â”€â”€ Position Calculation â”€â”€â”€
    const width = svg.clientWidth || 1000;
    const height = 300;
    const padding = { left: 80, right: 80 }; // Increased padding
    const usableWidth = width - padding.left - padding.right;
    const centerY = height / 2;

    // Sort by dDay
    timelinePoints.sort((a, b) => a.dDay - b.dDay);

    // Dedupe
    const uniquePoints = [];
    const seenDDays = new Set();
    timelinePoints.forEach(p => {
        if (!seenDDays.has(p.dDay)) {
            seenDDays.add(p.dDay);
            uniquePoints.push(p);
        }
    });
    timelinePoints = uniquePoints;

    // Calculate X, Y
    // Gentle wave: Just one nice arc or subtle sine.
    // Let's do a gentle sine: up then down.
    // Math.sin(progress * Math.PI) * -amplitude -> Standard Arc (Up)

    timelinePoints.forEach((p, i) => {
        const progress = p.dDay / maxDDay;
        p.x = padding.left + (usableWidth * progress);

        // "Gentle Journey" Curve
        // Combine a slight slope with a gentle sine
        const amplitude = 50;
        // progress * Math.PI * 1 => Single Hill
        // Let's use 1.5 PI => Hill then Valley
        p.y = centerY + Math.sin(progress * Math.PI * 1.2) * -amplitude;
    });

    // â”€â”€â”€ Draw Path â”€â”€â”€
    let d = `M ${timelinePoints[0].x} ${timelinePoints[0].y}`;

    for (let i = 0; i < timelinePoints.length - 1; i++) {
        const p0 = timelinePoints[i];
        const p1 = timelinePoints[i + 1];

        const cp1x = p0.x + (p1.x - p0.x) * 0.5;
        const cp1y = p0.y;
        const cp2x = p1.x - (p1.x - p0.x) * 0.5;
        const cp2y = p1.y;

        d += ` C ${cp1x} ${cp1y}, ${cp2x} ${cp2y}, ${p1.x} ${p1.y}`;
    }

    pathBg.setAttribute('d', d);
    pathActive.setAttribute('d', d);

    // â”€â”€â”€ Render Nodes â”€â”€â”€
    nodesContainer.innerHTML = '';
    timelinePoints.forEach((p, idx) => {
        const el = document.createElement('div');
        el.className = `timeline-node-group absolute cursor-pointer ${p.isStart ? 'active' : ''}`;
        el.style.left = `${p.x}px`;
        el.style.top = `${p.y}px`;
        el.style.transform = "translate(-50%, -50%)";

        let tooltipTitle = p.isStart ? "ì˜¤ëŠ˜" : (p.isEnd ? "ê²°í˜¼ì‹" : p.title);
        let tooltipDate = p.isStart ? new Date().toISOString().slice(0, 10).replace(/-/g, '.') : (p.date || "Event");

        // Custom Icon for End
        let iconSvg = `<circle class="timeline-node-bg" cx="20" cy="20" r="10"></circle>`;
        if (p.isEnd) {
            iconSvg = `<circle class="timeline-node-bg" cx="20" cy="20" r="12" stroke="#FF8E8E" fill="white"></circle>
                            <text x="20" y="24" text-anchor="middle" fill="#FF8E8E" font-size="12" font-weight="bold">â™¥</text>`;
        }

        el.innerHTML = `
                <div class="timeline-tooltip font-bold text-gray-600 text-xs shadow-xl">
                    <span class="block text-pink-500 mb-1">${p.label}</span>
                    ${tooltipTitle}
                    <div class="text-[9px] text-gray-300 font-normal mt-1">${tooltipDate}</div>
                </div>
                <svg width="40" height="40" class="overflow-visible transition-transform duration-300 hover:scale-125">
                    ${iconSvg}
                </svg>
                <div class="timeline-label-text absolute top-10 left-1/2 -translate-x-1/2 whitespace-nowrap bg-white/80 px-2 py-0.5 rounded-full backdrop-blur-sm">${p.label}</div>
            `;

        nodesContainer.appendChild(el);
    });
    });

    // Reveal Animation (Re-init)
    document.addEventListener('DOMContentLoaded', () => {
        const sections = document.querySelectorAll('.schedule-section.reveal');
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('revealed');
                    observer.unobserve(entry.target);
                }
            });
        }, { threshold: 0.1 });
        sections.forEach(s => observer.observe(s));
    });
</script>




<!-- ============================================================
     MODALS
     ============================================================ -->

<!-- Date Action Modal (Updated Design) -->
<div class="modal fade" id="dateActionModal" tabindex="-1" aria-labelledby="dateActionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 rounded-[24px] overflow-hidden"
            style="box-shadow: 0 25px 60px rgba(0,0,0,0.12);">
            <!-- Header -->
            <div
                style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); padding: 1.5rem 2rem; position: relative; overflow: hidden;">
                <div
                    style="position:absolute;inset:0;background-image:radial-gradient(circle at 1px 1px, rgba(255,255,255,0.04) 1px, transparent 0);background-size:24px 24px;">
                </div>
                <div style="position:relative;z-index:2;display:flex;align-items:center;gap:0.75rem;">
                    <div
                        style="width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,#FF8E8E,#FFB5B5);display:flex;align-items:center;justify-content:center;color:white;font-size:1rem;">
                        <i class="bi bi-calendar-plus"></i>
                    </div>
                    <div>
                        <h5 id="dateActionModalLabel" style="margin:0;color:white;font-weight:700;font-size:1.1rem;">ë‚ ì§œ
                            ì„ íƒ</h5>
                        <p style="margin:0;color:rgba(255,255,255,0.5);font-size:0.7rem;">ë©”ëª¨ ë˜ëŠ” ì¼ì •ì„ ë“±ë¡í•˜ì„¸ìš”</p>
                    </div>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"
                    style="position:absolute;top:1rem;right:1rem;opacity:0.5;"></button>
            </div>

            <div style="padding: 1.5rem 2rem; background: white;">
                <!-- Modal Tabs -->
                <div class="sch-modal-tabs">
                    <button class="sch-modal-tab sch-modal-tab--active" data-bs-toggle="pill"
                        data-bs-target="#memo-modal">
                        <i class="bi bi-journal-text"></i> ë©”ëª¨ ë“±ë¡
                    </button>
                    <button class="sch-modal-tab" data-bs-toggle="pill" data-bs-target="#task-modal">
                        <i class="bi bi-check-circle"></i> ì¼ì • ë“±ë¡
                    </button>
                </div>

                <div class="tab-content">
                    <!-- Memo Tab -->
                    <div class="tab-pane fade show active" id="memo-modal">
                        <form method="post">
                            {% csrf_token %}
                            <input type="hidden" name="date" id="modalDateInput">
                            <div style="margin-bottom:1rem;">
                                <textarea name="log_content"
                                    style="width:100%;height:130px;resize:none;border:2px solid #f0f0f0;border-radius:16px;padding:1rem;font-size:0.9rem;color:#374151;outline:none;transition:all 0.3s;background:#f8f9fa;"
                                    onfocus="this.style.borderColor='#FF8E8E';this.style.background='white';this.style.boxShadow='0 0 0 4px rgba(255,142,142,0.1)'"
                                    onblur="this.style.borderColor='#f0f0f0';this.style.background='#f8f9fa';this.style.boxShadow='none'"
                                    placeholder="ì´ ë‚ ì˜ ë©”ëª¨ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”..."></textarea>
                            </div>
                            <button type="submit"
                                style="width:100%;padding:0.85rem;border-radius:14px;border:none;background:linear-gradient(135deg,#FF8E8E,#ff7a7a);color:white;font-weight:700;font-size:0.9rem;cursor:pointer;box-shadow:0 4px 15px rgba(255,142,142,0.3);transition:all 0.3s;"
                                onmouseover="this.style.transform='translateY(-2px)'"
                                onmouseout="this.style.transform='translateY(0)'">
                                <i class="bi bi-check2-circle" style="margin-right:0.3rem;"></i> ì €ì¥í•˜ê¸°
                            </button>
                        </form>
                    </div>

                    <!-- Task Tab -->
                    <div class="tab-pane fade" id="task-modal">
                        <form method="post">
                            {% csrf_token %}
                            <input type="hidden" name="date" id="modalDateInputTask">
                            <div style="margin-bottom:1.25rem;">
                                <label
                                    style="font-size:0.75rem;font-weight:700;color:#9ca3af;text-transform:uppercase;letter-spacing:1px;margin-bottom:0.5rem;display:block;">í• 
                                    ì¼ ì„ íƒ</label>
                                <select name="task_id"
                                    style="width:100%;border:2px solid #f0f0f0;border-radius:14px;padding:0.85rem 1rem;font-size:0.9rem;color:#374151;outline:none;background:#f8f9fa;transition:all 0.3s;"
                                    onfocus="this.style.borderColor='#28a745';this.style.background='white';this.style.boxShadow='0 0 0 4px rgba(40,167,69,0.1)'"
                                    onblur="this.style.borderColor='#f0f0f0';this.style.background='#f8f9fa';this.style.boxShadow='none'">
                                    <option selected disabled>í•  ì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”</option>
                                    {% for task in unscheduled_tasks %}
                                    <option value="{{ task.id }}" {% if task.is_done %}disabled{% endif %}>{{ task.title }}</option>
                                    {% empty %}
                                    <option disabled>ë¯¸ì™„ë£Œëœ í•  ì¼ì´ ì—†ìŠµë‹ˆë‹¤.</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <button type="submit"
                                style="width:100%;padding:0.85rem;border-radius:14px;border:none;background:linear-gradient(135deg,#28a745,#20c997);color:white;font-weight:700;font-size:0.9rem;cursor:pointer;box-shadow:0 4px 15px rgba(40,167,69,0.3);transition:all 0.3s;"
                                onmouseover="this.style.transform='translateY(-2px)'"
                                onmouseout="this.style.transform='translateY(0)'">
                                <i class="bi bi-calendar-plus" style="margin-right:0.3rem;"></i> ì¼ì • ë“±ë¡í•˜ê¸°
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Date Picker Modal -->
<div class="modal fade" id="datePickerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content border-0 rounded-[20px] overflow-hidden"
            style="box-shadow: 0 20px 50px rgba(0,0,0,0.1);">
            <div
                style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); padding: 1.25rem 1.5rem; text-align:center;">
                <h5 style="margin:0;color:white;font-weight:700;font-size:1rem;">ğŸ“… ë‚ ì§œ ì´ë™</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    style="position:absolute;top:0.75rem;right:0.75rem;opacity:0.5;"></button>
            </div>
            <div style="padding:1.5rem;background:white;">
                <form action="" method="get">
                    <div style="margin-bottom:1rem;">
                        <label
                            style="font-size:0.7rem;font-weight:700;color:#9ca3af;text-transform:uppercase;letter-spacing:1px;margin-bottom:0.4rem;display:block;">ì—°ë„</label>
                        <select name="year"
                            style="width:100%;border:2px solid #f0f0f0;border-radius:12px;padding:0.7rem;font-size:0.9rem;outline:none;background:#f8f9fa;">
                            {% for y in year_range %}
                            <option value="{{ y }}" {% if y == current_year %}selected{% endif %}>{{ y }}ë…„</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div style="margin-bottom:1.25rem;">
                        <label
                            style="font-size:0.7rem;font-weight:700;color:#9ca3af;text-transform:uppercase;letter-spacing:1px;margin-bottom:0.4rem;display:block;">ì›”</label>
                        <select name="month"
                            style="width:100%;border:2px solid #f0f0f0;border-radius:12px;padding:0.7rem;font-size:0.9rem;outline:none;background:#f8f9fa;">
                            {% for m in "123456789012"|make_list %}
                            <option value="{{ forloop.counter }}" {% if forloop.counter == current_month %}selected{% endif %}>{{ forloop.counter }}ì›”</option>
                            {% endfor %}
                        </select>
                    </div>
                    <button type="submit"
                        style="width:100%;padding:0.8rem;border-radius:12px;border:none;background:linear-gradient(135deg,#FF8E8E,#ff7a7a);color:white;font-weight:700;cursor:pointer;">
                        ì´ë™í•˜ê¸°
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- ============================================================
     JAVASCRIPT
     ============================================================ -->
<script>
    // Date Selen Modal
    function selectDate(element, year, month, day) {
        const monthStr = month.toString().padStart(2, '0');
        const dayStr = day.toString().padStart(2, '0');
        const dateStr = `${year}-${monthStr}-${dayStr}`;

        document.getElementById('modalDateInput').value = dateStr;
        document.getElementById('modalDateInputTask').value = dateStr;

        const modalTitle = document.getElementById('dateActionModalLabel');
        if (modalTitle) {
            modalTitle.innerText = `${year}ë…„ ${month}ì›” ${day}ì¼`;
        }

        const logContent = element.getAttribute('data-log-content') || '';
        const memoTextarea = document.querySelector('#memo-modal textarea[name="log_content"]');
        if (memoTextarea) {
            memoTextarea.value = logContent;
        }

        const modal = new bootstrap.Modal(document.getElementById('dateActionModal'));
        modal.show();
    }

    // Custom Tab Switching (Side Panel)
    function switchTab(btn) {
        // Deactivate all
        document.querySelectorAll('.sch-tab').forEach(t => t.classList.remove('sch-tab--active'));
        document.querySelectorAll('.sch-tab-content').forEach(c => c.classList.remove('sch-tab-content--active'));
        // Activate clicked
        btn.classList.add('sch-tab--active');
        document.getElementById(btn.dataset.target).classList.add('sch-tab-content--active');
    }

    // Modal tab styling
    document.querySelectorAll('.sch-modal-tab').forEach(tab => {
        tab.addEventListener('click', function () {
            document.querySelectorAll('.sch-modal-tab').forEach(t => t.classList.remove('sch-modal-tab--active'));
            this.classList.add('sch-modal-tab--active');
        });
    });

    // â”€â”€â”€ Drag & Drop Logic â”€â”€â”€

    // Allow Drop
    function allowDrop(ev) {
        ev.preventDefault();
        // Visual feedback
        ev.currentTarget.style.background = "rgba(255, 142, 142, 0.1)";
    }

    // Drag Leave (Reset background)
    function dragLeave(ev) {
        ev.currentTarget.style.background = "";
    }

    // Drag Start
    document.addEventListener('dragstart', function (ev) {
        const trayItem = ev.target.closest('.tray-item');
        if (trayItem) {
            ev.dataTransfer.setData("text/plain", trayItem.dataset.id);
            ev.dataTransfer.effectAllowed = "move";
            trayItem.style.opacity = '0.5';
        }
    });

    document.addEventListener('dragend', function (ev) {
        const trayItem = ev.target.closest('.tray-item');
        if (trayItem) {
            trayItem.style.opacity = '1';
        }
    });

    // Drop
    function dropTask(ev, dateStr) {
        ev.preventDefault();
        ev.currentTarget.style.background = ""; // Reset styling

        const taskId = ev.dataTransfer.getData("text/plain");
        if (taskId) {
            if (confirm(`ì´ í•  ì¼ì„ ${dateStr}ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                // Submit hidden form
                const form = document.getElementById('dragDropForm');
                form.task_id.value = taskId;

                // Format date manually if needed, but dateStr passed from template should be YYYY-M-D
                // Ensure it is YYYY-MM-DD for backend
                const parts = dateStr.split('-');
                const y = parts[0];
                const m = parts[1].padStart(2, '0');
                const d = parts[2].padStart(2, '0');

                form.date.value = `${y}-${m}-${d}`;
                form.submit();
            }
        }
    }
</script>

<!-- Hidden Form for Drag & Drop -->
<form id="dragDropForm" method="post" style="display:none;">
    {% csrf_token %}
    <input type="hidden" name="task_id" value="">
    <input type="hidden" name="date" value="">
</form>

<!-- ============================================================
     STYLES
     ============================================================ -->
{% endblock %}
{% extends 'base.html' %}
{% load static %}

{% block title %}대시보드 - 웨딩 플래너{% endblock %}

{% block content %}
<style>
    .hero-bg {
        background: url('{% static "core/images/landing_bg.png" %}') center/cover;
        filter: brightness(0.7);
    }
</style>

<div class="row g-4 mb-5 fade-in">
    <!-- D-Day Hero Card -->
    <div class="col-12">
        <div class="card border-0 shadow-lg overflow-hidden text-white" style="border-radius: 20px;">
            <div class="card-body p-5 text-center position-relative">
                <div class="position-absolute top-0 start-0 w-100 h-100 hero-bg">
                </div>
                <div class="position-relative z-1">
                    <h5 class="fw-bold mb-3 letter-spacing-2 dashboard-header-text fs-4">WEDDING DAY</h5>
                    <h1 class="display-1 mb-0 dashboard-countdown fw-bold"
                        style="text-shadow: 2px 2px 4px rgba(0,0,0,0.2); font-size: 6rem;">
                        D-{{ d_day }}
                    </h1>
                    <p class="mt-3 fs-3 fw-bold opacity-100 font-refined"
                        style="text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">
                        {{ profile.user.username }}님의 결혼식이 {{ d_day }}일 남았습니다.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mb-5 fade-in" style="animation-delay: 0.2s;">
    <!-- Calendar Section -->
    <div class="col-lg-8">
        <div class="card border-0 shadow-sm glass-card h-100" style="border-radius: 20px;">
            <div class="card-header bg-transparent border-0 p-4 d-flex justify-content-between align-items-center">
                <a href="?year={{ prev_year }}&month={{ prev_month }}" class="btn btn-sm btn-light rounded-circle">
                    <i class="bi bi-chevron-left"></i>
                </a>
                <h4 class="fw-bold mb-0"><i class="bi bi-calendar-heart me-2 text-primary-custom"></i>
                    {{ current_year }}년 {{ current_month }}월</h4>
                <a href="?year={{ next_year }}&month={{ next_month }}" class="btn btn-sm btn-light rounded-circle">
                    <i class="bi bi-chevron-right"></i>
                </a>
            </div>
            <div class="card-body p-4">
                <table class="calendar-table w-100">
                    <thead>
                        <tr>
                            <th class="text-danger">일</th>
                            <th>월</th>
                            <th>화</th>
                            <th>수</th>
                            <th>목</th>
                            <th>금</th>
                            <th class="text-primary">토</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for week in calendar %}
                        <tr>
                            {% for day in week %}
                            <td>
                                {% if day != 0 %}
                                <div class="calendar-day
                                {% else %}
                                <div class=" calendar-day empty"></div>
                                {% endif %}
                            </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Daily Log Section -->
    <div class="col-lg-4">
        <div class="card border-0 shadow-sm h-100 glass-card" style="border-radius: 20px;">
            <div class="card-header bg-transparent border-0 p-4">
                <h5 class="fw-bold mb-0"><i class="bi bi-journal-text me-2 text-primary-custom"></i>
                    {{ selected_date.month }}월 {{ selected_date.day }}일의 기록</h5>
                <small class="text-muted" id="log-date-display">{{ selected_date.month }}월
                    {{ selected_date.day }}일</small>
            </div>
            <div class="card-body p-4 pt-0">
                <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="date" value="{{ selected_date|date:'Y-m-d' }}">
                    <div class="mb-3">
                        <textarea name="log_content" class="form-control border-0 bg-light rounded-3 p-3" rows="8"
                            placeholder="오늘 결혼 준비하며 있었던 일이나 생각을 기록해보세요..."
                            style="resize: none;">{{ current_log.content|default:'' }}</textarea>
                    </div>
                    <button type="submit" class="btn btn-primary w-100 rounded-pill py-2 fw-bold shadow-sm">
                        <i class="bi bi-save me-2"></i>저장하기
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mb-5 fade-in" style="animation-delay: 0.4s;">
    <!-- Upcoming Tasks -->
    <div class="col-lg-6">
        <div class="card border-0 shadow-sm h-100" style="border-radius: 20px;">
            <div class="card-header bg-white border-0 p-4">
                <h5 class="fw-bold mb-0">이번 주 할 일</h5>
            </div>
            <div class="card-body p-4 pt-0">
                {% if upcoming_tasks %}
                <div class="list-group list-group-flush">
                    {% for task in upcoming_tasks %}
                    <div class="list-group-item border-0 px-0 py-3 d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="rounded-circle bg-soft text-primary-custom d-flex align-items-center justify-content-center"
                                style="width: 40px; height: 40px;">
                                <i class="bi bi-check-lg"></i>
                            </div>
                        </div>
                        <div class="ms-3 flex-grow-1">
                            <h6 class="mb-1 fw-bold">{{ task.title }}</h6>
                            <small class="text-muted">{{ task.date|date:"m월 d일" }} (D-{{ task.d_day_offset }})</small>
                        </div>
                        <button class="btn btn-sm btn-outline-light text-muted rounded-circle">
                            <i class="bi bi-three-dots-vertical"></i>
                        </button>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-5 text-muted">
                    <i class="bi bi-calendar-check display-4 mb-3 opacity-25"></i>
                    <p>이번 주는 예정된 일정이 없습니다.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Vendor Status -->
    <div class="col-lg-6">
        <div class="card border-0 shadow-sm h-100" style="border-radius: 20px;">
            <div class="card-header bg-white border-0 p-4">
                <h5 class="fw-bold mb-0">업체 준비 현황</h5>
            </div>
            <div class="card-body p-4 pt-0">
                <div class="row g-3">
                    <div class="col-6">
                        <a href="{% url 'vendor_list' %}?category=venue" class="text-decoration-none">
                            <div
                                class="p-3 rounded-4 border-0 text-center transition-hover {% if vendor_status.venue %}bg-soft-success text-success{% else %}bg-light text-muted{% endif %}">
                                <i class="bi bi-building fs-1 mb-2 d-block"></i>
                                <span class="fw-bold small">예식장</span>
                                {% if vendor_status.venue %}<i class="bi bi-check-circle-fill ms-1"></i>{% endif %}
                            </div>
                        </a>
                    </div>
                    <div class="col-6">
                        <a href="{% url 'vendor_list' %}?category=studio" class="text-decoration-none">
                            <div
                                class="p-3 rounded-4 border-0 text-center transition-hover {% if vendor_status.studio %}bg-soft-success text-success{% else %}bg-light text-muted{% endif %}">
                                <i class="bi bi-camera fs-1 mb-2 d-block"></i>
                                <span class="fw-bold small">스튜디오</span>
                                {% if vendor_status.studio %}<i class="bi bi-check-circle-fill ms-1"></i>{% endif %}
                            </div>
                        </a>
                    </div>
                    <div class="col-6">
                        <a href="{% url 'vendor_list' %}?category=dress" class="text-decoration-none">
                            <div
                                class="p-3 rounded-4 border-0 text-center transition-hover {% if vendor_status.dress %}bg-soft-success text-success{% else %}bg-light text-muted{% endif %}">
                                <i class="bi bi-person-heart fs-1 mb-2 d-block"></i>
                                <span class="fw-bold small">드레스</span>
                                {% if vendor_status.dress %}<i class="bi bi-check-circle-fill ms-1"></i>{% endif %}
                            </div>
                        </a>
                    </div>
                    <div class="col-6">
                        <a href="{% url 'vendor_list' %}?category=makeup" class="text-decoration-none">
                            <div
                                class="p-3 rounded-4 border-0 text-center transition-hover {% if vendor_status.makeup %}bg-soft-success text-success{% else %}bg-light text-muted{% endif %}">
                                <i class="bi bi-brush fs-1 mb-2 d-block"></i>
                                <span class="fw-bold small">메이크업</span>
                                {% if vendor_status.makeup %}<i class="bi bi-check-circle-fill ms-1"></i>{% endif %}
                            </div>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{{ current_year|json_script:"current-year-data" }}
<script>
    function selectDate(element, year, month, day) {
        // Construct the date string YYYY-MM-DD

        // Pad month and day with leading zeros if needed
        const monthStr = month.toString().padStart(2, '0');
        const dayStr = day.toString().padStart(2, '0');
        const dateStr = `${year}-${monthStr}-${dayStr}`;

        // Reload page with selected date, keeping the current calendar view
        window.location.href = `?date=${dateStr}&year=${year}&month=${month}`;
    }
</script>
{% endblock %}
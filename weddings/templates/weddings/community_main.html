{% extends "base.html" %}
{% load static humanize %}

{% block title %}커뮤니티 - 웨딩 플래너{% endblock %}

{% block content %}
<!-- Navigation Tabs -->
{% include 'weddings/includes/_dashboard_tabs.html' %}

<!-- ═══════════════════════════════════════════════════════════
     COMMUNITY TAB — Simple Table Layout
     ═══════════════════════════════════════════════════════════ -->

<div class="max-w-7xl mx-auto px-4 md:px-8 mb-20 font-sans">

    <!-- Title Section -->
    <div class="text-center mb-10">
        <h2 class="text-3xl font-bold text-gray-900 tracking-tight font-serif italic">Community</h2>
        <div class="w-8 h-0.5 bg-gray-800 mx-auto mt-4 mb-8"></div>

        <!-- Category Filters -->
        <div
            class="flex justify-center gap-8 text-sm font-medium text-gray-400 uppercase tracking-widest border-b border-gray-200 pb-4 max-w-2xl mx-auto">
            <a href="?{% if search_query %}q={{ search_query }}{% endif %}"
                class="transition-colors pb-4 -mb-4 border-b-2 {% if not category_filter %}text-black border-black font-bold{% else %}hover:text-black border-transparent{% endif %}">
                All
            </a>
            {% for code, name in CATEGORIES %}
            <a href="?category={{ code }}{% if search_query %}&q={{ search_query }}{% endif %}"
                class="transition-colors pb-4 -mb-4 border-b-2 {% if category_filter == code %}text-black border-black font-bold{% else %}hover:text-black border-transparent{% endif %}">
                {{ name }}
            </a>
            {% endfor %}
        </div>
    </div>

    <!-- Main Table -->
    <div class="bg-white border-t-2 border-gray-800 mb-8">
        <table class="w-full text-sm text-gray-600">
            <thead class="border-b border-gray-200 bg-gray-50/50">
                <tr>
                    <th class="py-4 px-4 font-medium text-gray-500 w-[80px] text-center">No</th>
                    <th class="py-4 px-4 font-medium text-gray-500 w-[100px] text-center">Category</th>
                    <th class="py-4 px-4 font-medium text-gray-500 text-left">제목</th>
                    <th class="py-4 px-4 font-medium text-gray-500 w-[120px] text-center">글쓴이</th>
                    <th class="py-4 px-4 font-medium text-gray-500 w-[120px] text-center">작성시간</th>
                    <th class="py-4 px-4 font-medium text-gray-500 w-[80px] text-center">조회</th>
                    <th class="py-4 px-4 font-medium text-gray-500 w-[80px] text-center">추천</th>
                </tr>
            </thead>
            <tbody>
                <!-- Notices (Pinned) -->
                {% for notice in notices %}
                <tr class="border-b border-gray-100 hover:bg-gray-50 transition-colors cursor-pointer bg-gray-50/30"
                    onclick="window.location.href='#'">
                    <td class="py-4 px-4 text-center">
                        <span
                            class="inline-block px-2 py-0.5 bg-gray-200 text-gray-600 text-[10px] font-bold rounded">NOTICE</span>
                    </td>
                    <td class="py-4 px-4 text-center text-gray-400">-</td>
                    <td class="py-4 px-4 font-medium text-gray-800">
                        {{ notice.title }}
                        {% if notice.comment_count > 0 %} <span class="text-gray-400 text-xs ml-1">[{{ notice.comment_count }}]</span> {% endif %}
                    </td>
                    <td class="py-4 px-4 text-center text-gray-500">관리자</td>
                    <td class="py-4 px-4 text-center text-gray-400">{{ notice.created_at|date:"Y-m-d" }}</td>
                    <td class="py-4 px-4 text-center text-gray-400">-</td>
                    <td class="py-4 px-4 text-center text-gray-400">-</td>
                </tr>
                {% endfor %}

                <!-- Hot Posts (Pinned) -->
                {% for post in top_posts %}
                <tr class="border-b border-gray-100 hover:bg-pink-50/30 transition-colors cursor-pointer bg-pink-50/10"
                    onclick="window.location.href='{% url 'post_detail' post.id %}'">
                    <td class="py-4 px-4 text-center text-pink-500 font-bold text-lg">
                        <i class="bi bi-fire"></i>
                    </td>
                    <td class="py-4 px-4 text-center">
                        <span class="text-xs font-bold text-pink-500">HOT</span>
                    </td>
                    <td class="py-4 px-4 font-bold text-gray-800">
                        {% if post.image %}
                        <i class="bi bi-image text-gray-400 mr-1"></i>
                        {% endif %}
                        {{ post.title }}
                        {% if post.comment_count > 0 %} <span class="text-pink-500 text-xs font-bold ml-1">[{{ post.comment_count }}]</span> {% endif %}
                    </td>
                    <td class="py-4 px-4 text-center text-gray-600 font-bold">{{ post.author.first_name|default:post.author.username }}</td>
                    <td class="py-4 px-4 text-center text-gray-400 text-xs">{{ post.created_at|date:"Y-m-d" }}</td>
                    <td class="py-4 px-4 text-center text-gray-400 text-xs">{{ post.view_count }}</td>
                    <td class="py-4 px-4 text-center text-pink-500 font-bold text-xs">{{ post.recommendation_count }}
                    </td>
                </tr>
                {% endfor %}

                <!-- Posts -->
                {% for post in posts %}
                <tr class="border-b border-gray-100 hover:bg-gray-50 transition-colors cursor-pointer"
                    onclick="window.location.href='{% url 'post_detail' post.id %}'">
                    <td class="py-4 px-4 text-center text-gray-400 font-light">{{ post.id }}</td>
                    <td class="py-4 px-4 text-center">
                        <span class="text-xs font-medium 
                            {% if post.category == 'QUESTION' %}text-blue-500
                            {% elif post.category == 'REVIEW' %}text-green-500
                            {% elif post.category == 'TIP' %}text-purple-500
                            {% else %}text-gray-500{% endif %}">
                            {{ post.get_category_display }}
                        </span>
                    </td>
                    <td class="py-4 px-4 font-medium text-gray-700 hover:text-black transition-colors">
                        <!-- Image Icon if exists -->
                        {% if post.image %}
                        <i class="bi bi-image text-gray-400 mr-1"></i>
                        {% endif %}
                        {{ post.title }}
                        {% if post.comment_count > 0 %} <span class="text-pink-400 text-xs font-bold ml-1">[{{ post.comment_count }}]</span> {% endif %}
                        {% if post.created_at|date:"Y-m-d" == today|date:"Y-m-d" %}
                        <span class="ml-1 inline-block w-1.5 h-1.5 bg-red-400 rounded-full align-middle"></span>
                        {% endif %}
                    </td>
                    <td class="py-4 px-4 text-center text-gray-500">{{ post.author.first_name|default:post.author.username }}</td>
                    <td class="py-4 px-4 text-center text-gray-400 text-xs">{{ post.created_at|date:"Y-m-d" }}</td>
                    <td class="py-4 px-4 text-center text-gray-400 text-xs">{{ post.view_count }}</td>
                    <td class="py-4 px-4 text-center text-gray-400 text-xs">{{ post.recommendation_count }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" class="py-20 text-center text-gray-400">
                        게시글이 없습니다. 첫 번째 글을 작성해보세요!
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Bottom Actions: Search (Center) & Write (Right) -->
    <div class="flex flex-col md:flex-row justify-between items-center gap-4 relative mt-8">
        <!-- Spacer for center alignment -->
        <div class="w-full md:w-1/3"></div>

        <!-- Search Bar (Center) -->
        <div class="w-full md:w-1/3 flex justify-center">
            <form method="get" action="{% url 'community_main' %}" class="relative w-full max-w-[300px]">
                <input type="text" name="q" value="{{ search_query|default:'' }}"
                    class="w-full pl-3 pr-10 py-2 border border-gray-300 rounded-none text-sm focus:outline-none focus:border-gray-500 transition-colors"
                    placeholder="Search">
                <button type="submit"
                    class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
                    <i class="bi bi-search"></i>
                </button>
            </form>
        </div>

        <!-- Write Button (Right) -->
        <div class="w-full md:w-1/3 flex justify-end">
            <a href="{% url 'post_create' %}"
                class="px-8 py-3 bg-gray-900 text-white text-xs font-bold tracking-widest hover:bg-gray-800 transition-colors uppercase">
                글쓰기
            </a>
        </div>
    </div>

    <!-- Pagination -->
    {% if posts.has_other_pages %}
    <div class="flex justify-center items-center gap-4 mt-12 text-sm text-gray-500 font-medium">
        {% if posts.has_previous %}
        <a href="?page={{ posts.previous_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}"
            class="hover:text-black p-2"><i class="bi bi-chevron-left"></i></a>
        {% endif %}

        {% for page_num in posts.paginator.page_range %}
        {% if page_num == posts.number %}
        <span class="text-black font-bold border-b border-black pb-0.5">{{ page_num }}</span>
        {% elif page_num > posts.number|add:"-5" and page_num < posts.number|add:"5" %} <a
            href="?page={{ page_num }}{% if search_query %}&q={{ search_query }}{% endif %}"
            class="hover:text-black transition-colors">{{ page_num }}</a>
            {% endif %}
            {% endfor %}

            {% if posts.has_next %}
            <a href="?page={{ posts.next_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}"
                class="hover:text-black p-2"><i class="bi bi-chevron-right"></i></a>
            {% endif %}
    </div>
    {% endif %}

</div>
{% endblock %}
{% extends "base.html" %}
{% load static humanize %}

{% block title %}커뮤니티 - 웨딩 플래너{% endblock %}

{% block content %}
<div class="container py-4">
    {% include 'weddings/includes/_dashboard_tabs.html' %}

    <div class="row fade-in">
        <div class="col-12">
            <div class="card border-0 shadow-sm" style="border-radius: 20px;">
                <div class="card-header bg-white border-0 p-4">
                    <div class="d-flex justify-content-end">
                        <ul class="nav nav-pills mb-0" id="communityTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link btn-sm active" id="qna-tab" data-bs-toggle="pill"
                                    data-bs-target="#qna" type="button" role="tab" aria-controls="qna"
                                    aria-selected="true">
                                    자유게시판
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link btn-sm" id="notice-tab" data-bs-toggle="pill"
                                    data-bs-target="#notice" type="button" role="tab" aria-controls="notice"
                                    aria-selected="false">
                                    공지사항
                                </button>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="card-body p-4 pt-0">
                    <div class="tab-content" id="communityTabsContent">
                        <!-- 자유게시판 (Community) Tab - ACTIVE -->
                        <div class="tab-pane fade show active" id="qna" role="tabpanel" aria-labelledby="qna-tab">
                            <div class="mb-4">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <a href="{% url 'post_create' %}"
                                        class="btn btn-primary-custom btn-sm shadow-sm rounded-pill px-3">
                                        <i class="bi bi-pencil-fill me-1"></i>글쓰기
                                    </a>
                                    <form class="d-flex gap-2" method="get">
                                        <div class="input-group input-group-sm" style="max-width: 300px;">
                                            <span class="input-group-text bg-light border-end-0">
                                                <i class="bi bi-search text-muted"></i>
                                            </span>
                                            <input type="text" name="q" class="form-control bg-light border-start-0"
                                                placeholder="제목, 작성자, 본문내용" value="{{ search_query }}">
                                        </div>
                                        <select name="sort" class="form-select form-select-sm" style="width: 100px;"
                                            onchange="this.form.submit()">
                                            <option value="date" {% if sort_option == 'date' %}selected{% endif %}>최신순
                                            </option>
                                            <option value="likes" {% if sort_option == 'likes' %}selected{% endif %}>추천순
                                            </option>
                                        </select>
                                    </form>
                                </div>

                                <div class="table-responsive">
                                    <table class="table table-hover align-middle">
                                        <thead class="bg-light">
                                            <tr>
                                                <th scope="col" class="py-3 text-center" style="width: 10%;">순번
                                                </th>
                                                <th scope="col" class="py-3 ps-3" style="width: 50%;">제목</th>
                                                <th scope="col" class="py-3 text-center" style="width: 20%;">작성자
                                                </th>
                                                <th scope="col" class="py-3 text-center" style="width: 20%;">
                                                    작성일자</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for post in posts %}
                                            <tr onclick="location.href='{% url 'post_detail' post.id %}'"
                                                style="cursor: pointer;">
                                                <td class="text-center text-muted fs-6">
                                                    {{ forloop.revcounter }}
                                                </td>
                                                <td class="ps-3 py-3">
                                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                                        <span class="fw-bold text-dark text-truncate fs-5"
                                                            style="max-width: 60%;">
                                                            {{ post.title }}
                                                        </span>
                                                        <div class="d-flex align-items-center text-muted">
                                                            <div class="me-3 d-flex align-items-center">
                                                                <i class="bi bi-chat-dots me-1 fs-6"></i>
                                                                <span class="fs-6">{{ post.comment_count }}</span>
                                                            </div>
                                                            <div class="d-flex align-items-center">
                                                                <i class="bi bi-heart me-1 text-danger fs-6"></i>
                                                                <span class="fs-6">{{ post.recommendation_count }}</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <p class="mb-0 text-muted small text-truncate fw-light"
                                                        style="max-width: 90%; font-size:15px;">
                                                        {{ post.content|truncatechars:50 }}
                                                    </p>
                                                </td>
                                                <td class="text-center text-primary-custom fw-bold fs-6">
                                                    {{ post.author.first_name|default:post.author.username }}
                                                </td>
                                                <td class="text-center text-muted fs-6">
                                                    {{ post.created_at|date:"Y.m.d H:i" }}
                                                </td>
                                            </tr>
                                            {% empty %}
                                            <tr>
                                                <td colspan="4" class="text-center py-5 text-muted">
                                                    <div class="mb-3">
                                                        <i class="bi bi-chat-square-text fs-1 text-light"></i>
                                                    </div>
                                                    <p>조건에 맞는 게시글이 없습니다.</p>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>

                                <!-- Pagination -->
                                {% if posts.has_other_pages %}
                                <nav aria-label="Page navigation" class="mt-4">
                                    <ul class="pagination justify-content-center">
                                        {% if posts.has_previous %}
                                        <li class="page-item">
                                            <a class="page-link border-0 text-muted rounded-circle d-flex align-items-center justify-content-center mx-1"
                                                href="?page={{ posts.previous_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}{% if sort_option %}&sort={{ sort_option }}{% endif %}"
                                                style="width: 32px; height: 32px;">
                                                <i class="bi bi-chevron-left"></i>
                                            </a>
                                        </li>
                                        {% endif %}

                                        {% for i in posts.paginator.page_range %}
                                        {% if posts.number == i %}
                                        <li class="page-item active">
                                            <span
                                                class="page-link border-0 rounded-circle d-flex align-items-center justify-content-center mx-1 bg-primary-custom text-white"
                                                style="width: 32px; height: 32px;">{{ i }}</span>
                                        </li>
                                        {% else %}
                                        <li class="page-item">
                                            <a class="page-link border-0 text-muted rounded-circle d-flex align-items-center justify-content-center mx-1"
                                                href="?page={{ i }}{% if search_query %}&q={{ search_query }}{% endif %}{% if sort_option %}&sort={{ sort_option }}{% endif %}"
                                                style="width: 32px; height: 32px;">{{ i }}</a>
                                        </li>
                                        {% endif %}
                                        {% endfor %}

                                        {% if posts.has_next %}
                                        <li class="page-item">
                                            <a class="page-link border-0 text-muted rounded-circle d-flex align-items-center justify-content-center mx-1"
                                                href="?page={{ posts.next_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}{% if sort_option %}&sort={{ sort_option }}{% endif %}"
                                                style="width: 32px; height: 32px;">
                                                <i class="bi bi-chevron-right"></i>
                                            </a>
                                        </li>
                                        {% endif %}
                                    </ul>
                                </nav>
                                {% endif %}
                            </div>
                        </div>

                        <!-- 공지사항 (Notice) Tab -->
                        <div class="tab-pane fade" id="notice" role="tabpanel" aria-labelledby="notice-tab">
                            <div class="list-group list-group-flush">
                                {% for notice in notices %}
                                <div class="list-group-item border-0 px-0 py-3">
                                    <div class="d-flex w-100 justify-content-between align-items-center mb-1">
                                        <h6 class="mb-1 fw-bold text-dark">{{ notice.title }}</h6>
                                        <small class="text-muted">{{ notice.created_at|date:"Y.m.d" }}</small>
                                    </div>
                                    <p class="mb-1 text-muted small">
                                        {{ notice.content|truncatechars:100 }}
                                    </p>
                                </div>
                                {% empty %}
                                <div class="text-center py-5 text-muted">
                                    <p>등록된 공지사항이 없습니다.</p>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}